name: Release Binaries

on:
  push:
    tags:
      - 'v*.*.*'

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION"

      - name: Generate Changelog
        id: changelog
        run: |
          CURRENT_TAG="${{ steps.version.outputs.tag }}"
          
          # Find the previous tag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | grep -v "^${CURRENT_TAG}$" | head -n1)
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "ðŸ“ No previous tag found, using last 3 commits"
            COMMITS=$(git log -3 --pretty=format:"%s" --no-merges)
            COMPARE_URL=""
          else
            echo "ðŸ“ Comparing $PREVIOUS_TAG...$CURRENT_TAG"
            COMMITS=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"%s" --no-merges)
            COMPARE_URL="https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${CURRENT_TAG}"
          fi
          
          # Parse Angular-style commits and generate changelog
          {
            echo "## What's Changed"
            echo ""
            
            # Features (feat:)
            FEATURES=$(echo "$COMMITS" | grep -E "^feat(\(.+\))?:" | sed 's/^feat\(.*\):\s*/- âœ¨ /' || true)
            if [ -n "$FEATURES" ]; then
              echo "### âœ¨ Features"
              echo "$FEATURES"
              echo ""
            fi
            
            # Bug Fixes (fix:)
            FIXES=$(echo "$COMMITS" | grep -E "^fix(\(.+\))?:" | sed 's/^fix\(.*\):\s*/- ðŸ› /' || true)
            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes"
              echo "$FIXES"
              echo ""
            fi
            
            # Performance (perf:)
            PERF=$(echo "$COMMITS" | grep -E "^perf(\(.+\))?:" | sed 's/^perf\(.*\):\s*/- âš¡ /' || true)
            if [ -n "$PERF" ]; then
              echo "### âš¡ Performance"
              echo "$PERF"
              echo ""
            fi
            
            # Refactor (refactor:)
            REFACTOR=$(echo "$COMMITS" | grep -E "^refactor(\(.+\))?:" | sed 's/^refactor\(.*\):\s*/- â™»ï¸ /' || true)
            if [ -n "$REFACTOR" ]; then
              echo "### â™»ï¸ Refactor"
              echo "$REFACTOR"
              echo ""
            fi
            
            # Docs (docs:)
            DOCS=$(echo "$COMMITS" | grep -E "^docs(\(.+\))?:" | sed 's/^docs\(.*\):\s*/- ðŸ“š /' || true)
            if [ -n "$DOCS" ]; then
              echo "### ðŸ“š Documentation"
              echo "$DOCS"
              echo ""
            fi
            
            # Chore/Build/CI (chore:, build:, ci:)
            CHORE=$(echo "$COMMITS" | grep -E "^(chore|build|ci)(\(.+\))?:" | sed 's/^[a-z]*\(.*\):\s*/- ðŸ”§ /' || true)
            if [ -n "$CHORE" ]; then
              echo "### ðŸ”§ Chores"
              echo "$CHORE"
              echo ""
            fi
            
            # Style (style:)
            STYLE=$(echo "$COMMITS" | grep -E "^style(\(.+\))?:" | sed 's/^style\(.*\):\s*/- ðŸ’„ /' || true)
            if [ -n "$STYLE" ]; then
              echo "### ðŸ’„ Style"
              echo "$STYLE"
              echo ""
            fi
            
            # Other commits (not matching Angular convention)
            OTHER=$(echo "$COMMITS" | grep -vE "^(feat|fix|perf|refactor|docs|chore|build|ci|style|test)(\(.+\))?:" | grep -v "^$" | sed 's/^/- /' || true)
            if [ -n "$OTHER" ]; then
              echo "### ðŸ“¦ Other Changes"
              echo "$OTHER"
              echo ""
            fi
            
            # Add compare link if available
            if [ -n "$COMPARE_URL" ]; then
              echo "---"
              echo ""
              echo "**Full Changelog**: [${PREVIOUS_TAG}...${CURRENT_TAG}](${COMPARE_URL})"
            fi
          } > CHANGELOG.md
          
          echo "ðŸ“‹ Generated changelog:"
          cat CHANGELOG.md
          
          # Save to output (escape newlines for GitHub Actions)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web-src/package-lock.json

      - name: Build Frontend
        run: |
          cd web-src
          npm ci
          npm run build

      - name: Build for AMD64 (x86_64) Linux
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: amd64
          APP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "ðŸ”¨ Building gd-webhook-server for linux/amd64..."
          go build -trimpath -ldflags="-s -w" -o gd-webhook-server ./src
          
          # Create tarball
          tar -czvf gd-webhook-server-amd64-linux.tar.gz \
            gd-webhook-server \
            config.json.exmaple \
            README.md \
            README_CN.md \
            LICENSE
          
          rm gd-webhook-server
          echo "âœ… AMD64 build complete"

      - name: Build for ARM64 (aarch64) Linux
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: arm64
          APP_VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "ðŸ”¨ Building gd-webhook-server for linux/arm64..."
          go build -trimpath -ldflags="-s -w" -o gd-webhook-server ./src
          
          # Create tarball
          tar -czvf gd-webhook-server-aarch64-linux.tar.gz \
            gd-webhook-server \
            config.json.exmaple \
            README.md \
            README_CN.md \
            LICENSE
          
          rm gd-webhook-server
          echo "âœ… ARM64 build complete"

      - name: Generate SHA512 checksums
        run: |
          echo "ðŸ” Generating SHA512 checksums..."
          sha512sum gd-webhook-server-amd64-linux.tar.gz gd-webhook-server-aarch64-linux.tar.gz > gd-webhook-server.sha512sum
          cat gd-webhook-server.sha512sum
          echo "âœ… Checksums generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: ${{ steps.version.outputs.tag }}
          tag_name: ${{ steps.version.outputs.tag }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, '-') }}
          files: |
            gd-webhook-server-amd64-linux.tar.gz
            gd-webhook-server-aarch64-linux.tar.gz
            gd-webhook-server.sha512sum
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts (temporary, expires in 7 days)
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries-${{ steps.version.outputs.tag }}
          path: |
            gd-webhook-server-amd64-linux.tar.gz
            gd-webhook-server-aarch64-linux.tar.gz
            gd-webhook-server.sha512sum
          retention-days: 7
          if-no-files-found: error
